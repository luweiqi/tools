#include <stdio.h>
<<<<<<< HEAD
=======
#include <stdint.h>
>>>>>>> 3fec14219e625d7cedd8624dd663a406bf7ad7c9
#include <string.h>
#include <errno.h>
#include <unistd.h>
#include <wiringPi.h>
<<<<<<< HEAD
=======
#include <unistd.h>
>>>>>>> 3fec14219e625d7cedd8624dd663a406bf7ad7c9


//void gpio_write()

/* wiringPi GPIO num */
#define GPIO_I2C_SCL   (25)
#define GPIO_I2C_SDA   (24)

<<<<<<< HEAD
//#define BIT_TIME_US 104 /* 9600 baud */
//#define BIT_TIME_US 833 /* 1200 baud */

//#define BIT_TIME_US     (1000000 / 600) /* 600 baud */
#define BIT_TIME_US     (1000000 / 300) /* 300 baud */

#define UART_GPIO_SET(x) do {if(x) {digitalWrite(UART_GPIO, HIGH);} else {digitalWrite(UART_GPIO, LOW);}} while(0)

#define SCL_SET(x) do {if(x) {digitalWrite(GPIO_I2C_SCL, HIGH);} else {digitalWrite(GPIO_I2C_SCL, LOW);}} while(0)
#define SCL_GET()  digitalRead(GPIO_I2C_SCL) /* FIXME: config mode to input */
=======
#define SCL_SET(x) do {if(x) {digitalWrite(GPIO_I2C_SCL, HIGH);} else {digitalWrite(GPIO_I2C_SCL, LOW);}} while(0)
>>>>>>> 3fec14219e625d7cedd8624dd663a406bf7ad7c9

#define SDA_SET(x) do {if(x) {digitalWrite(GPIO_I2C_SDA, HIGH);} else {digitalWrite(GPIO_I2C_SDA, LOW);}} while(0)
#define SDA_GET()  digitalRead(GPIO_I2C_SDA)

<<<<<<< HEAD
void i2c_start()
{
    SCL_SET(1);
    SDA_SET(1);

    SDA_SET(0);
    SCL_SET(0);
=======
#define SDA_OUTPUT() pinMode(GPIO_I2C_SDA, OUTPUT)
#define SDA_INPUT()  pinMode(GPIO_I2C_SDA, INPUT)

#define DELAY   (10)

void i2c_start()
{
    SDA_OUTPUT();

    SDA_SET(1);
    usleep(DELAY);

    SCL_SET(1);
    usleep(DELAY);

    SDA_SET(0);
    usleep(DELAY);
>>>>>>> 3fec14219e625d7cedd8624dd663a406bf7ad7c9
}

void i2c_stop()
{
<<<<<<< HEAD
    SCL_SET(0);
    SDA_SET(0);

    SCL_SET(1);
    SDA_SET(1);
=======
    SDA_OUTPUT();

    SDA_SET(0);
    usleep(DELAY);

    SCL_SET(1);
    usleep(DELAY);

    SDA_SET(1);
    usleep(DELAY);
}

#define ACK  (0)
#define NACK (1)
uint8_t i2c_send_ack(uint8_t ack)
{

    SCL_SET(0);
    usleep(DELAY);

    SDA_OUTPUT();

    SDA_SET(ack);   /* 0: ACK; 1: NACK */

    SCL_SET(1);
    usleep(DELAY);

    SCL_SET(0);   //SCL = 0;
    usleep(DELAY);

    return 0;

}

uint8_t i2c_recv_ack()
{
    uint8_t ack;

    SDA_INPUT();

    SDA_SET(1);
    usleep(DELAY);

    SCL_SET(1);
    usleep(DELAY);

    if (SDA_GET() == 1) {
        ack = 1;
    } else {
        ack = 0;
    }

    SCL_SET(0);
    usleep(DELAY);

    return ack;
}

uint8_t i2c_send(uint8_t data)
{
    uint8_t i, rv;

    SCL_SET(0);

    SDA_OUTPUT();
    usleep(DELAY);

    for(i = 0; i < 8; i++) {

        if ((data << i) & 0x80) {
            SDA_SET(1);
        } else {
            SDA_SET(0);
        }

        usleep(DELAY);

        SCL_SET(1);
        usleep(DELAY);
        SCL_SET(0);
        usleep(DELAY);
    }

    rv = i2c_recv_ack();

    if (rv) {
        printf("%s-%d fail\n", __func__, __LINE__);
    }

    return rv;

}

uint8_t i2c_recv()
{
    uint8_t i, data = 0;

    SDA_INPUT();

    //SCL_SET(1);
    //usleep(DELAY);

    for(i = 0; i < 8; i++) {
        
        SCL_SET(0);
        usleep(DELAY);
        SCL_SET(1);
        usleep(DELAY);

        data <<= 1;
        data = data | (SDA_GET());
        usleep(DELAY);
    }

    //i2c_send_ack(ACK);

    return data;
>>>>>>> 3fec14219e625d7cedd8624dd663a406bf7ad7c9
}

void i2c_writeb(unsigned char byte)
{
	unsigned char i;
    unsigned char ack;

	for(i = 0; i < 8; i++) {
		if(byte & 0x80) {
			SDA_SET(1);
		} else {
		    SDA_SET(0);
		}

		SCL_SET(1);
		SCL_SET(0);
		byte <<= 1;
	}

	SDA_SET(1);
	SCL_SET(1);
	SCL_SET(0);
}

<<<<<<< HEAD
int i2c_init()
{

=======
#define GT911_SLAVEADDR (0xBA)
#define I2C_WRITE   (0x0)
#define I2C_READ    (0x1)

void gt911_read(uint16_t addr, uint8_t *buf, uint32_t size)
{

    uint32_t i;

    printf("read 0x%x\n", addr);

    /* 1. START */
    i2c_start();

    /* 2. send slave addr with Write */
    i2c_send(GT911_SLAVEADDR | I2C_WRITE);
            
    /* 3. send reg addr */
    i2c_send(addr >> 8);

    i2c_send(addr & 0xFF);

    /* 4. START */
    i2c_start();

    /* 5. send slave addr with Read */
    i2c_send(GT911_SLAVEADDR | I2C_READ); /* 0x0: W; 0x1: R */

    /* 6. read */
    for(i = 0; i < size; i++) {
        buf[i] = i2c_recv();

        if (i == (size - 1)) {
            //printf("nack\n");
            i2c_send_ack(NACK); /* NACK */
        } else {
            //printf("ack\n");
            i2c_send_ack(ACK);
        }

        printf("[0x%x]: 0x%x\n", addr + i, buf[i]);
        usleep(DELAY);
    }

    /* 7. STOP */
    i2c_stop(); 

}

void gt911_write(uint16_t addr,  uint8_t *buf, uint32_t size)
{
	uint32_t i;
	
	printf("write 0x%x\n", addr);
	
	/* 1. START */
	i2c_start();
	
	/* 2. send slave addr with Write */
	i2c_send(GT911_SLAVEADDR | I2C_WRITE); /* 0x0: W; 0x1: R */
	
	/* 3. send reg addr */
	i2c_send(addr >> 8);
	
	i2c_send(addr & 0xFF);

	/* 4. send data */
	for(i = 0; i < size; i++) {
		i2c_send(buf[i]);
	}
	
	/* 5. STOP */
	i2c_stop();

}

#define GT_CTRL_REG     0X8040 
#define GT_CFGS_REG     0X8047 
#define GT_CHECK_REG    0X80FF 
#define GT_PID_REG      0X8140 

#define GT_GSTID_REG    0X814E 
#define GT_TP1_REG      0X8150 
#define GT_TP2_REG      0X8158 
#define GT_TP3_REG      0X8160 
#define GT_TP4_REG      0X8168 
#define GT_TP5_REG      0X8170 

#if 1
static const uint8_t gt911_config[] =
{
	0x68, 0x20, 0x03, 0xE0, 0x01, 0x05, 0x3D, 0x00, 0x01, 0x48,
	0x28, 0x0D, 0x50, 0x32, 0x03, 0x05, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x18, 0x1A, 0x1E, 0x14, 0x8A, 0x2A, 0x0C,
	0x30, 0x38, 0x31, 0x0D, 0x00, 0x00, 0x02, 0xB9, 0x03, 0x2D,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x64, 0x32, 0x00, 0x00,
	0x00, 0x1D, 0x41, 0x94, 0xC5, 0x02, 0x07, 0x00, 0x00, 0x04,
	0xA5, 0x1F, 0x00, 0x94, 0x25, 0x00, 0x88, 0x2B, 0x00, 0x7D,
	0x33, 0x00, 0x74, 0x3C, 0x00, 0x74, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x18, 0x16, 0x14, 0x12, 0x10, 0x0E, 0x0C, 0x0A,
	0x08, 0x06, 0x04, 0x02, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x24, 0x22, 0x21, 0x20, 0x1F, 0x1E, 0x1D, 0x1C,
	0x18, 0x16, 0x13, 0x12, 0x10, 0x0F, 0x0A, 0x08, 0x06, 0x04,
	0x02, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
};
#endif

#if 0
static const uint8_t gt911_config[] =
{
0x00, //0x8047
0xE0,0x01, //0x8048/8049
0x56,0x03, //0x804a/804b
0x01, //0x804c 
0x35, //0x804d
0x00, //0x804e
0x02, //0x804f
0x08, //0x8050
0x28, //0x8051
0x0A, //0x8052
0x5A, //0x8053
0x46, //0x8054
0x03, //0x8055
0x05, //0x8056
0x00, //0x8057
0x00, //0x8058
0x00,0X00, //0x8059-0x805a reserved 
0x00, //0x805b reserved 
0x00, //0x805c reserved 
0x00, //0x805d
0x18, //0x805e
0x1A, //0x805f
0x1E, //0x8060
0x14, //0x8061
0x8C, //0x8062
0x28, //0x8063
0x0C, //0x8064
0x71, //0x8065
0x73, //0x8066
0xB2, //0x8067
0x04, //0x8068
0x00, //0x8069
0x00, //0x806a
0x00, //0x806b
0x02, //0x806c
0x03, //0x806d
0x1D, //0x806e
0x00, //0x806f reserved 
0x01, //0x8070
0x00,0x00, //reserved 
0x00, //0x8073
0x00,0x00,0x00,0x00,0x00,0x00, //0x8071 - 0x8079 reserved 
0x50, //0x807a
0xA0, //0x807b
0x94, //0x807c
0xD5, //0x807d
0x02, //0x807e
0x07, //0x807f
0x00,0x00, //0x8081 reserved 
0x04, //0x8082
0xA4, //0x8083 
0x55, //0x8084
0x00, //0x8085
0x91, //0x8086 
0x62, //0x8087
0x00, //0x8088
0x80, //0x8089
0x71, //0x808a
0x00, //0x808b
0x71, //0x808c 
0x82, //0x808d
0x00, //0x808e
0x65, //0x808f
0x95, //0x8090
0x00, 0x65, //reserved 
0x00, //0x8093
0x00, //0x8094
0x00, //0x8095
0x00, //0x8096
0x00, //0x8097
0x00, //0x8098 reserved 
0x00, //0x8099 reserved 
0x00, //0x809a reserved 
0x00, //0x809b reserved 
0x00, //0x809c reserved 
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, //0x809d-0x80b2 reserved 
0x00, //0x80b3
0x00, //0x80b4 
0x00,0x00, //0x80b6 reserved 
0x06, //0x80b7 
0x08, //0x80b8 
0x0A, //0x80b9 
0x0C, //0x80ba 
0x0E, //0x80bb 
0x10, //0x80bc 
0x12, //0x80bd 
0x14, //0x80be 
0x16, //0x80bf 
0x18, //0x80c0 
0x1A, //0x80c1 
0x1C, //0x80c2 
0xFF, //0x80c3 
0xFF, //0x80c4 
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 
0x00,0x00,0x00 
,0x00, //0x80c5-0x80d4 reserved 
0x00, //0x80d5 
0x02, //0x80d6 
0x04, //0x80d7 
0x06, //0x80d8 
0x08, //0x80d9 
0x0A, //0x80da 
0x0C, //0x80db 
0x0F, //0x80dc 
0x10, //0x80dd 
0x12, //0x80de 
0x13, //0x80df 
0x14, //0x80e0 
0x16, //0x80e1 
0x18, //0x80e2
0x1C, //0x80e3 
0x1D, //0x80e4 
0x1E, //0x80e5 
0x1F, //0x80e6 
0x20, //0x80e7 
0x21, //0x80e8 
0xFF, //0x80e9 
0xFF, //0x80ea 
0xFF, //0x80eb 
0xFF, //0x80ec 
0xFF, //0x80ed 
0xFF, //0x80ee 
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 
0x00,0x00,0x00,0x00, //0x80ef-0x80fe reserved 
0x0B, //0x80ff
0x01 //0x8100
};
#endif


uint8_t gt911_config1[] =
{
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
};

int i2c_init()
{

    uint8_t i, addr, rv;
    uint16_t x, y;

    uint8_t buf[16] = {0};


>>>>>>> 3fec14219e625d7cedd8624dd663a406bf7ad7c9
    if (wiringPiSetup() < 0) {
        fprintf(stderr, "Unable to setup wiringPi: %s\n", strerror(errno));
        return 1;
    }

    /* wiringPi GPIO num */
    pinMode(GPIO_I2C_SCL, OUTPUT);
    pinMode(GPIO_I2C_SDA, OUTPUT);

<<<<<<< HEAD
=======
#if 0
    for(addr = 0; addr < 0xff; addr++) {

        printf("0x%x ", addr);

        i2c_start();

        rv = i2c_send(addr);

        if (rv) {
            printf("fail!\n");
        } else {
            printf("succ!\n");
        }

        i2c_stop();
    }
#endif

    gt911_read(0x8140, buf, 16);

    gt911_read(0x8040, buf, 16);

    rv = 0x02;
    gt911_write(GT_CTRL_REG, &rv, 1);

    rv = 0;

    gt911_read(GT_CFGS_REG, &rv, 1);
    printf("config_version: [0x%02x]\n", rv);

    gt911_write(GT_CFGS_REG, (uint8_t*)gt911_config, sizeof(gt911_config));

    gt911_read(GT_CFGS_REG, (uint8_t*)gt911_config1, sizeof(gt911_config1));

	for(i = 0; i < sizeof(gt911_config1); i++) {
        printf("0x%02x ", gt911_config1[i]);
    }
    printf("\n");

    rv = 0x02;
    gt911_write(GT_CTRL_REG, &rv, 1);

    while (1) {
        gt911_read(GT_GSTID_REG, &rv, 1);
        printf("rv: 0x%02x\n", rv);

        if ((rv & 0x0F) == 0) {
            rv = 0;
            gt911_write(GT_GSTID_REG, &rv, 1);
            continue;
        }

        gt911_read(GT_TP1_REG, buf, 8);

        //printf("%x %x %x %x\n", buf[0], buf[1], buf[2], buf[3]);
        x = (buf[1] << 8) + buf[0];
        y = (buf[3] << 8) + buf[2];
        printf("[%d, %d]\n", x, y);

        rv = 0;
        gt911_write(GT_GSTID_REG, &rv, 1);

        usleep(1000000);

#if 0
        memset(buf, 0, sizeof(buf));
        gt911_read(GT_TP1_REG, buf, 8);

        rv = 0;
        gt911_write(GT_GSTID_REG, &rv, 1);
#endif
    }

>>>>>>> 3fec14219e625d7cedd8624dd663a406bf7ad7c9
    return 0;
}
